<div class="flex flex-col mb-auto px-2 pt-5" id="main">
  <div class="flex justify-between pb-2">
    <h1>Pre-hire Check <%= @job.id %></h1>
    <%= link_to "View Template", template_path(@job.template, job_id: @job.id), class: "text-green-600 hover:underline" if current_user.admin? %>
  </div>
  <div class="flex justify-between border-b pb-4">
    <p><%= @job.item.Name %></p>
    <p><%= @job.item.PartNumber %></p>
  </div>
  <div class="flex justify-between border-b pb-2 mt-2">
      <p>Branch <%= @job.item.CurrentStore %></p>
      <p><%= Time.now.strftime("%a %d/%m/%Y %H:%M") %></p>
  </div>
  <%= form_with model: @job, url: job_path(@job), method: :patch, local: true do |f| %>
    <%= f.fields_for :job_data, @job_data do |jd| %>
      <%= jd.hidden_field :item_num, value: @job.item_num %>
      <%= jd.hidden_field :header, value: @job.item.Header %>
      <%= jd.hidden_field :part_num, value: @job.item.PartNumber %>
      <%= jd.hidden_field :store, value: @job.store %>
      <%= jd.hidden_field :completed_at, value: Time.now %>
      <div data-controller="operator" data-operator-operators='<%= @operators.to_json(only: [:OPID, :OPNM]) %>'>
        <div class="flex items-center justify-between border-b pb-3 mt-3">
          <div class="flex justify-between items-center">
            <%= jd.label :opid, "Enter initials:", class: "text-sm font-bold"%>
            <%= jd.text_field :opid, class: "block w-12 px-2 py-1 mx-4 text-sm bg-gray-50 border-gray-300 focus:outline-none focus:ring-green-600 focus:border-green-800 rounded-md", data: { action: "input->operator#updateName" } %>
            <%= jd.label :opnm, "User", class: "text-sm ml-10 font-bold" %>
          </div>
          <div>
            <p id="opnm-display" data-operator-target="name" class="text-sm text-gray-700"></p>
            <%= jd.hidden_field :opnm, data: { operator_target: "hiddenName" } %>
          </div>
        </div>
      </div>
      <div data-controller="fuel">
        <% if (@job.item.FUEL == "cFUEL" || @job.item.FUEL == "cUNFUEL") || @job.item.TYPE == "H" %>
          <div class="flex justify-between pb-4 mt-4 border-b">
            <% if @job.item.FUEL == "cFUEL" || @job.item.FUEL == "cUNFUEL" %>
              <div class="flex justify-end items-center text-sm">
                <div data-fuel-target="fuelAdd" class="flex justify-between items-center">
                  <%= jd.label :fuel_req, "Does the item require fuel?", class: "font-bold" %>
                  <%= jd.check_box :fuel_req, { class: "cursor-pointer w-6 h-6 ml-2 text-green-600 bg-gray-100 border-gray-300 rounded focus:ring-green-500 focus:ring-2", data: { action: "input->fuel#fuelRequired" } }, "true", "false" %>
                </div>
                <div data-fuel-target="fuelEntry" class="justify-between items-center hidden">
                  <%= jd.label :fuel, "Fuel taken:", class: "font-bold" %>
                  <%= jd.number_field :fuel, step: "any", class: "bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-green-500 focus:border-green-500 block w-20 ml-2 py-1 px-2" %>
                </div>
              </div>
            <% end %>
            <% if @job.item.TYPE == "H" %>
              <div class="flex justify-end items-center text-sm">
                <%= jd.label :hours, "Engine hours:", class: "font-bold" %>
                <%= jd.number_field :hours, step: "any", class: "bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-green-500 focus:border-green-500 block w-20 ml-2 py-1 px-2" %>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>
      <div class="flex items-center border-b pb-4 mt-4">
        <%= jd.label :photo1, "Add photo:", class: "flex-1 w-min text-sm font-bold" %>
        <%= jd.file_field :photo1, accept: 'image/*', capture: 'camera', class: "text-sm ml-2 border-gray-300 rounded focus:ring-green-500 focus:ring-2" %>
      </div>
      <div class="flex items-center border-b pb-4 mt-4">
        <%= jd.label :photo2, "Add photo:", class: "flex-1 w-min text-sm font-bold" %>
        <%= jd.file_field :photo2, accept: 'image/*', capture: 'camera', class: "text-sm ml-2 border-gray-300 rounded focus:ring-green-500 focus:ring-2" %>
      </div>
      <div class="flex items-center border-b pb-4 mt-4">
        <%= jd.label :photo3, "Add photo:", class: "flex-1 w-min text-sm font-bold" %>
        <%= jd.file_field :photo3, accept: 'image/*', capture: 'camera', class: "text-sm ml-2 border-gray-300 rounded focus:ring-green-500 focus:ring-2" %>
      </div>
      <div class="flex items-center border-b pb-4 mt-4">
        <%= jd.label :photo4, "Add photo:", class: "flex-1 w-min text-sm font-bold" %>
        <%= jd.file_field :photo4, accept: 'image/*', capture: 'camera', class: "text-sm ml-2 border-gray-300 rounded focus:ring-green-500 focus:ring-2" %>
      </div>
      <div class="mt-1">
        <% @job.template.questions.each_with_index do |question, index| %>
          <div class="flex justify-between border-b pb-4 mt-4">
            <%= simple_format question.content unless question.qtype == "alrt" || question.qtype == "img" %>
            <% if question.qtype == "bool" %>
              <%= jd.check_box "bool#{index}", { class: "cursor-pointer w-6 h-6 ml-4 text-green-600 bg-gray-100 border-gray-300 rounded focus:ring-green-500 focus:ring-2" }, "true", "false" %>
            <% elsif question.qtype == "text" %>
              <%= jd.text_field "text#{index}", class: "bg-gray-50 border border-gray-300 text-gray-900 h-8 text-sm rounded-lg focus:ring-green-500 focus:border-green-500 block w-40 p-1.5 ml-3 mt-0.25" %>
            <% elsif question.qtype == "num" %>
              <%= jd.number_field "num#{index}", step: "any", class: "bg-gray-50 border border-gray-300 text-gray-900 h-8 text-sm rounded-lg focus:ring-green-500 focus:border-green-500 block w-40 p-1.5 ml-3 mt-0.25" %>
            <% elsif question.qtype == "img" %>
              <%= image_tag "#{question.content}", class: "w-full" %>
            <% elsif question.qtype == "alrt" %>
              <%= simple_format question.content, class: "text-red-600 font-semibold" %>
            <% end %>
          </div>
        <% end %>
        <% if @accessories %>
          <div class="flex flex-col justify-between pb-4 mt-4 border-b">
            <h3 class="mb-1 font-bold">Accessories check (tick all that are returned)</h3>
            <% @accessories.each_with_index do |accessory, index| %>
              <div class="flex justify-between items-center my-1">
                <%= jd.label "accessory#{index}", accessory.MiscName, class: "text-sm" %>
                <%= jd.check_box "accessory#{index}", { class: "cursor-pointer w-6 h-6 ml-4 text-green-600 bg-gray-100 border-gray-300 rounded focus:ring-green-500 focus:ring-2" }, "true", "false" %>
              </div>
            <% end %>
          </div>
        <% end %>
      <% end %>
      <%= f.hidden_field :id, value: @job.id %>
      <%= f.hidden_field :item_num, value: @job.item_num %>
      <%= f.hidden_field :completed_at, value: Time.now %>
      <div class="flex justify-between items-center my-8">
        <%= f.submit "Complete", class: "text-white bg-green-600 hover:bg-green-800 focus:ring-4 focus:ring-green-300 font-medium rounded-lg text-xs px-4 py-2 focus:outline-none" %>
        <%= link_to "Back to PHCs", jobs_path, class: "text-white bg-green-600 hover:bg-green-800 focus:ring-4 focus:ring-green-300 font-medium rounded-lg text-xs px-4 py-2 focus:outline-none" %>
      </div>
    <% end %>
  </div>

</div>
