<div class="flex flex-col mb-auto px-2" id="main" data-controller="returns-entry">
  <div class="flex flex-col">
    <div class="flex justify-center">
      <h2>Contract Returns</h2>
    </div>
    <div class="flex justify-center mt-4">
      <h3 class="mb-2">Search by:</h3>
    </div>
    <div class="flex justify-center items-center">
      <div data-returns-entry-target="plantNumberBtn" class="mx-4">
        <%= button_tag "Plant Number", type: "button", data: { action: "returns-entry#showPlantNumberInput" }, class: "text-white bg-green-600 hover:bg-green-800 focus:ring-4 focus:ring-green-300 font-medium rounded-lg text-xs px-4 py-2 my-1.5 focus:outline-none" %>
      </div>
      <div data-returns-entry-target="qrCodeBtn" class="mx-4">
        <%= button_tag "QR Code", type: "button", data: { action: "returns-entry#showScanInput" }, class: "text-white bg-green-600 hover:bg-green-800 focus:ring-4 focus:ring-green-300 font-medium rounded-lg text-xs px-4 py-2 my-1.5 focus:outline-none" %>
      </div>
      <div data-returns-entry-target="customerBtn" class="mx-4">
        <%= button_tag "Customer", type: "button", data: { action: "returns-entry#showCustomerInput" }, class: "text-white bg-green-600 hover:bg-green-800 focus:ring-4 focus:ring-green-300 font-medium rounded-lg text-xs px-4 py-2 my-1.5 focus:outline-none" %>
      </div>
    </div>
    <%= form_with url: returns_path, method: :get, class: "hidden", data: { returns_entry_target: "formDiv" } do |form| %>
      <div class="flex flex-col items-center mt-4 pb-4">
        <%# plant number input %>
        <div data-returns-entry-target="plantNumberInput" class="hidden">
          <%= form.text_field :part_number, placeholder: "Enter plant number", class: "block w-36 px-2 py-1 text-sm text-center bg-gray-50 border-gray-300 focus:outline-none focus:ring-green-600 focus:border-green-800 rounded-md" %>
        </div>
        <%# qr code scanner %>
        <div data-returns-entry-target="qrCodeInput" class="hidden fixed inset-0 bg-black bg-opacity-50 items-center justify-center">
          <div class="bg-white rounded-lg p-4 shadow-xl">
            <div data-returns-entry-target="qrCodeCanvas" class="flex-col items-center">
              <video data-returns-entry-target="video" class="w-3/4 h-auto bg-gray-200 border-green-600 border-3 mb-2" style="border: 4px solid rgb(22 163 74); width: 75%; height: auto;"></video>
              <canvas data-returns-entry-target="canvas" class="hidden"></canvas>
              <%= link_to "Cancel", returns_path, class: "text-white bg-green-600 hover:bg-green-800 focus:ring-4 focus:ring-green-300 font-medium rounded-lg text-xs px-4 py-2 my-1.5 focus:outline-none" %>
            </div>
          </div>
        </div>
        <%# qr code input %>
        <div data-returns-entry-target="inputDiv" class="hidden flex-col justify-center items-center">
          <%= form.text_field :qr_number, placeholder: "Enter plant number", class: "block w-36 px-2 py-1 text-sm text-center bg-gray-50 border-gray-300 focus:outline-none focus:ring-green-600 focus:border-green-800 rounded-md", data: { returns_entry_target: "input" } %>
        </div>
        <%# customer input %>
        <div data-returns-entry-target="customerInput" class="hidden">
          <%= form.text_field :customer, placeholder: "Enter customer name", list: "customer_names", class: "block w-72 px-2 py-1 ml-2 text-sm bg-gray-50 border-gray-300 focus:outline-none focus:ring-green-600 focus:border-green-800 rounded-md" %>
          <datalist id="customer_names">
            <% @customer_names.uniq.each do |name| %>
              <option value="<%= name %>"></option>
            <% end %>
          </datalist>
        </div>
        <div class="flex justify-between items-center mx-4">
          <%= link_to "Cancel", returns_path, class: "text-white bg-green-600 hover:bg-green-800 focus:ring-4 focus:ring-green-300 font-medium rounded-lg text-xs px-4 py-2 my-2 mx-1 focus:outline-none" %>
          <%= form.submit "Search", class: "hidden text-white bg-green-600 hover:bg-green-800 focus:ring-4 focus:ring-green-300 font-medium rounded-lg text-xs px-4 py-2 my-2 mx-1 focus:outline-none", data: { returns_entry_target: "formSubmitBtn" } %>
        </div>
      </div>
    <% end %>
    <% if params[:customer].present? %>
      <%= form_with url: returns_path, autocomplete: "off", method: :get, class: "" do |form| %>
        <div class="flex flex-col items-center mt-4">
          <h3>Customer selected:</h3>
          <h3><%= @customer.NAME %></h3>
        </div>
        <div class="flex justify-center mt-2">
          <%= form.text_field :contract, name: "contract_#{SecureRandom.hex(8)}", placeholder: "Select contract", list: "contract_nums", class: "block w-44 px-2 py-1 ml-2 text-sm bg-gray-50 border-gray-300 focus:outline-none focus:ring-green-600 focus:border-green-800 rounded-md", onchange: "this.form.submit();" %>
          <datalist id="contract_nums">
            <% @contract_nums.each do |contract_num| %>
              <option value="<%= contract_num %>"></option>
            <% end %>
          </datalist>
          <%= form.hidden_field :customer, value: params[:customer] %>
          </div>
      <% end %>
    <% end %>
  </div>
  <div class="flex flex-col mt-12">
    <% if @return %>
      <div class="flex flex-col items-center">
        <h2>Customer: <%= @return.customer.NAME %></h2>
        <div class="flex flex-col items-center">
          <div class="flex justify-between">
            <h4 class="px-2">Items on hire</h4>
            <h4 class="px-2">Contract #<%= @return.CNTR %></h4>
          </div>
          <table class="text-xs w-full text-left my-4">
            <thead class="text-xs uppercase">
              <tr>
                <th class="px-3 py-1.5 bg-green-50">Item</th>
                <th class="px-3 py-1.5 bg-green-50">Qty</th>
                <th class="px-3 py-1.5 bg-green-50">Name</th>
              </tr>
            </thead>
            <tbody>
              <% @return.contract_items.each do |item| %>
                <% next if item.QTY.zero? %>
                <tr class="bg-white border-b">
                  <td class="px-3 py-1.5"><%= item.item.KEY %></td>
                  <td class="px-3 py-1.5"><%= item.QTY.round(0) %></td>
                  <td class="px-3 py-1.5"><%= item.item.Name %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
        <div class="flex justify-between w-full px-8 mt-4">
          <%= link_to "Reset page", returns_path, class: "text-white bg-green-600 hover:bg-green-800 focus:ring-4 focus:ring-green-300 font-medium rounded-lg text-xs px-4 py-2 my-1.5 focus:outline-none" %>
          <%= link_to return_path(@return.id) do %>
            <%= button_tag "Return Contract ##{@return.CNTR}", type: "button", class: "text-white bg-green-600 hover:bg-green-800 focus:ring-4 focus:ring-green-300 font-medium rounded-lg text-xs px-4 py-2 my-1.5 focus:outline-none" %>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>
</div>
